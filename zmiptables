#!/bin/bash
# Written by: Rick King, Zimbra Support Team
# Date: November 30, 2011

if [ `whoami` != "zimbra" ]; then
echo "You must be the zimbra user to run this script."
exit 0
fi

if [ ! -f /usr/bin/uniq ]; then
echo "We need uniq."
exit 0
fi

if [ ! -f /sbin/iptables ]; then
echo "We need iptables."
exit 0
fi

printusage() {
echo "Description: Generate list of IP's from undesirable senders, and add them to your denied IPTables list.

1) Usage: $0 iptab   	    # Display Default IpTable Config

2) Usage: $0 setup	    # Running the script for the first time?

3) Usage: $0 spammy         # Give me the sender IP from the msg marked as spam

4) Usage: $0 blockedspam    # Give me the sender IP from the msg blocked as spam

5) Usage: $0 reject         # Give me the sender IP from the msg marked as rejected

6) Usage: $0 denied         # Give me the IP from a relay denied session

7) Usage: $0 badheader      # Give me the sender IP with malformed headers

8) Usage: $0 discard        # Give me the discarded message's IP

9) Usage: $0 save           # Save the IPTable config

10) Usage: $0 rebuild	    # Rebuild the iptables list

11) Usage: $0 list          # List IP's getting denied, and how many times

12) Usage: $0 check         # Compare IPTables list between the kernel and flat list

13) Usage: $0 smtpflood     # Search for IP's attempting to run multiple consecutive smtp connections

14) Usage: $0 search        # Search for individual IP address

15) Usage: $0 add           # Add individual IP address

16) Usage: $0 remove        # Remove indivual IP address

17) Usage: $0 sort          # Sort the IPTables in numerical order
"

}

printhelp() {
echo "
Setup
.....
In order to run this script, you will need to make sure the following is in the /etc/sudoers.
As root, run: visudo

And add the following to the bottom of the file: %zimbra ALL=NOPASSWD:/sbin/iptables, /sbin/iptables-save, /sbin/iptables-restore



Check
.......

Everynow and then, I like to have my IP lists sorted; just because I like to have IP lists in numeric order, also, parse out any duplicate IP's. 
For this task run:

$0 check

If there is a difference in the numbers, chances are the live IPtables may have duplicates, i.e. $0 rebuild

"
}

printiptablesconfig() {
echo "# Generated by iptables-save v1.3.5 on Wed Dec  7 22:05:40 2011
*filter
:INPUT ACCEPT [2470:704619]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [2329:698540]
:LOGDROP - [0:0]
-A INPUT -i eth0 -p tcp -m tcp --dport 25 -m state --state NEW -m recent --update --seconds 60 --hitcount 10 --name SMTPFLOOD --rsource -j LOGDROP
-A INPUT -i eth0 -p tcp -m tcp --dport 25 -m state --state NEW -m recent --set --name SMTPFLOOD --rsource
-A LOGDROP -j LOG --log-prefix \"Denied TCP: \" --log-level 7
-A LOGDROP -j DROP
COMMIT
# Completed on Wed Dec  7 22:05:40 2011"
}

if [ ! -d /opt/zimbra/conf/iptables ]; then mkdir /opt/zimbra/conf/iptables/; fi

if [ ! -f /opt/zimbra/conf/iptables/zmiptables_list ]; then touch /opt/zimbra/conf/iptables/zmiptables_list; fi

if [ -z $1 ]; then
   printusage
   exit 0;
elif [ -n $1 ]; then
   cmd=$1
fi

case "$cmd" in
	iptab)
	printiptablesconfig
	;;
	setup)
	printhelp
	;;
	spammy)
        for i in `zgrep SPAMMY /var/log/zimbra.log* | awk -F"[" '{ print $3 }' | sed 's/]//g' | sort -n | uniq | grep -v -e 127.0.0.1 -e 192.168.1.19` 
        do
        grep "$i" /opt/zimbra/conf/iptables/zmiptables_list > /dev/null 
        RETVAL=$? 
	   if [ $RETVAL = 1 ]; then 
  	      echo $i >> /tmp/spammylist
	   fi 
	done
	  if [ ! -f /tmp/spammylist ]; then
	    echo "No new Spammy IP's found"
	   else
   	    echo "Adding Spammer IP's to the IPTables Blocklist"
	    echo "---------------------------------------------"
	    echo "`cat /tmp/spammylist`"
	    for ip in `cat /tmp/spammylist`; do sudo /sbin/iptables -A INPUT -i eth0 -p tcp -s "$ip" -j LOGDROP; done
	    cat /tmp/spammylist >> /opt/zimbra/conf/iptables/zmiptables_list
	    rm -rf /tmp/spammylist
	  fi
        ;;
	blockedspam)
        for i in `zgrep "Blocked SPAM" /var/log/zimbra* | awk -F"[" '{ print $3 }' | sed 's/]//g' | sort -n | uniq | grep -v -e 127.0.0.1 -e 192.168.1.19`
        do
        grep "$i" /opt/zimbra/conf/iptables/zmiptables_list > /dev/null 
        RETVAL=$? 
	   if [ $RETVAL = 1 ]; then 
  	      echo $i >> /tmp/blockedlist
	   fi 
	done
	  if [ ! -f /tmp/blockedlist ]; then
	    echo "No new Blocked Spam IP's found"
	   else
   	    echo "Adding Blocked Spammer IP's to the IPTables Blocklist"
	    echo "-----------------------------------------------------"
	    echo "`cat /tmp/blockedlist`"
	    for ip in `cat /tmp/blockedlist`; do sudo /sbin/iptables -A INPUT -i eth0 -p tcp -s "$ip" -j LOGDROP; done
	    cat /tmp/blockedlist >> /opt/zimbra/conf/iptables/zmiptables_list
	    rm -rf /tmp/blockedlist
	  fi
        ;;
	reject)
        for i in `zgrep reject /var/log/zimbra.log* | awk -F"[" '{ print $3 }' | awk '{ print $1 }' | sed 's/\]\://g' | sort -n | uniq | grep -v -e 127.0.0.1 -e 192.168.1.19` 
	do 
	grep "$i" /opt/zimbra/conf/iptables/zmiptables_list > /dev/null
	RETVAL=$? 
	  if [ $RETVAL = 1 ]; then 
	    echo $i >> /tmp/rejectlist
	  fi 
	done 
	  if [ ! -f /tmp/rejectlist ]; then
	    echo "No new rejected IP's found"
	  else
	    echo "Adding Rejected IP's to the IPTables Blocklist"
	    echo "----------------------------------------------"
	    echo "`cat /tmp/rejectlist`"
	    for ip in `cat /tmp/rejectlist`; do sudo /sbin/iptables -A INPUT -i eth0 -p tcp -s "$ip" -j LOGDROP; done
	    cat /tmp/rejectlist >> /opt/zimbra/conf/iptables/zmiptables_list
	    rm -rf /tmp/rejectlist
	  fi
	;;
	denied)
	for i in `zgrep "Relay access denied" /var/log/zimbra* | awk -F"[" '{ print $3 }' | awk '{ print $1 }' | sed -e 's/]://g' | sort -n | uniq`
	do
	grep "$i" /opt/zimbra/conf/iptables/zmiptables_list > /dev/null
	RETVAL=$? 
	  if [ $RETVAL = 1 ]; then 
	    echo $i >> /tmp/relaydeniedlist
	  fi 
	done 
	  if [ ! -f /tmp/relaydeniedlist ]; then
	    echo "No new Relay Denied  IP's found"
	  else
	    echo "IP's that tried to relay, now are added to the IPTables Blocklist"
	    echo "-----------------------------------------------------------------"
	    echo "`cat /tmp/relaydeniedlist`"
	    for ip in `cat /tmp/relaydeniedlist`; do sudo /sbin/iptables -A INPUT -i eth0 -p tcp -s "$ip" -j LOGDROP; done
	    cat /tmp/relaydeniedlist >> /opt/zimbra/conf/iptables/zmiptables_list
	    rm -rf /tmp/relaydeniedlist
	  fi
	;;
	badheader)
	for i in `zgrep "Blocked BAD-HEADER" /var/log/zimbra* | awk -F"[" '{ print $3 }' | sed 's/]//g' | sort -n | uniq | grep -v -e 127.0.0.1 -e 192.168.1.19`
	do
	grep "$i" /opt/zimbra/conf/iptables/zmiptables_list > /dev/null
	RETVAL=$? 
	  if [ $RETVAL = 1 ]; then 
	    echo $i >> /tmp/bhlist
	  fi 
	done 
	  if [ ! -f /tmp/bhlist ]; then
	    echo "No new messages with bad headers IP's found"
	  else
	    echo "Adding Messages with bad headers with IP's to the IPTables Blocklist"
	    echo "--------------------------------------------------------------------"
	    echo "`cat /tmp/bhlist`"
	    for ip in `cat /tmp/bhlist`; do sudo /sbin/iptables -A INPUT -i eth0 -p tcp -s "$ip" -j LOGDROP; done
	    cat /tmp/bhlist >> /opt/zimbra/conf/iptables/zmiptables_list
	    rm -rf /tmp/bhlist
	  fi
	;;
	discard)
	for i in `zgrep "discard: header" /var/log/zimbra.log* | awk -F";" '{ print $1 }' | awk '{ print $NF }' | sed -e 's/\[/ /g' -e 's/\]$//g' | awk '{ print $NF }' | sort -n | uniq | grep -v -e '127.0.0.1' -e '192.168.1.19'`
	do
	grep "$i" /opt/zimbra/conf/iptables/zmiptables_list > /dev/null
	RETVAL=$? 
	  if [ $RETVAL = 1 ]; then 
	    echo $i >> /tmp/discardlist
	  fi 
	done 
	  if [ ! -f /tmp/discardlist ]; then
	    echo "No new discarded messages"
	  else
	    echo "New Discarded Messages with their IP's, added to the IPTables blocklist"
	    echo "-----------------------------------------------------------------------"
	    echo "`cat /tmp/discardlist`"
	    for ip in `cat /tmp/discardlist`; do sudo /sbin/iptables -A INPUT -i eth0 -p tcp -s "$ip" -j LOGDROP; done
	    cat /tmp/discardlist >> /opt/zimbra/conf/iptables/zmiptables_list
	    rm -rf /tmp/discardlist
	  fi
	;;
	save)
	echo "Saving IPtables config to /opt/zimbra/conf/iptables/zmiptables-`date +%F`.fw"
	if [ -f "/opt/zimbra/conf/iptables/zmiptables-`date +%F`.fw" ]; then rm -rf "/opt/zimbra/conf/iptables/zmiptables-`date +%F`.fw"; fi
	sudo /sbin/iptables-save >> /opt/zimbra/conf/iptables/zmiptables-`date +%F`.fw
	;;
	rebuild)
	source $0 iptab >> /opt/zimbra/conf/iptables/zmiptabDefault.fw
	source $0 save
	sudo /sbin/iptables -F
	sudo /sbin/iptables-restore < /opt/zimbra/conf/iptables/zmiptabDefault.fw; sleep 1; rm -rf /opt/zimbra/conf/iptables/zmiptabDefault.fw
	for ip in `cat /opt/zimbra/conf/iptables/zmiptables_list`; do sudo /sbin/iptables -A INPUT -i eth0 -p tcp -s "$ip" -j LOGDROP; done
	;;
	list)
	echo "List IP's getting denied, and how many times"
	echo "--------------------------------------------"
	cat /var/log/iptables.log | grep -v "last message repeated" | awk '{ print $11 }' | sed 's/SRC=//g' | sort -n | uniq -c | sort -r
	;;
	check)
	source $0 sort >> /opt/zimbra/conf/iptables/zmiptables_list.sorted
	if [ -f /opt/zimbra/conf/iptables/zmiptables_list.bak ];then rm -rf /opt/zimbra/conf/iptables/zmiptables_list.bak; fi
	  mv /opt/zimbra/conf/iptables/zmiptables_list.sorted /opt/zimbra/conf/iptables/zmiptables_list
	echo "Lets check how many IP's are on file compare to what is live in the IPTables, shall we?"
	  echo "How many on file: `cat /opt/zimbra/conf/iptables/zmiptables_list | wc -l`"; echo; echo "How many in the IPtables: `$0 sort | wc -l`"
	;;
	smtpflood)
	for ip in `cat /var/log/iptables.log | grep -v "last message repeated" | awk '{ print $11 }' | sed 's/SRC=//g' | sort -n | uniq`; do grep "$ip" /opt/zimbra/conf/iptables/zmiptables_list > /dev/null; if [ $? != 0 ]; then echo "$ip not listed"; fi; done
	;;	
	search)
	echo "IP Address: " 
	read IP
	grep "$IP" /opt/zimbra/conf/iptables/zmiptables_list > /dev/null
	RETVAL=$?
	echo
	if [ $RETVAL = 1 ]; then echo "IP address $IP is **not** listed"; else echo "IP address $IP **IS** already listed"; fi
	;;
	add)
	echo "Add IP"
	read ADD
	sudo /sbin/iptables -A INPUT -i eth0 -p tcp -s "$ADD" -j LOGDROP
	echo "$ADD" >> /opt/zimbra/conf/iptables/zmiptables_list
	echo "Done"
	;;
	remove)
	echo "Remove IP"
	read DEL
	sudo /sbin/iptables -D INPUT -i eth0 -p tcp -s "$DEL" -j LOGDROP
	cat /opt/zimbra/conf/iptables/zmiptables_list | grep -v "$DEL" >> /opt/zimbra/conf/iptables/zmiptables_list.tmp; rm -rf /opt/zimbra/conf/iptables/zmiptables_list; mv /opt/zimbra/conf/iptables/zmiptables_list.tmp /opt/zimbra/conf/iptables/zmiptables_list
	echo "Done"
	;;
	sort)
	sudo /sbin/iptables -L -n  | sed -e '1,4d' | grep ^LOGDROP | awk '{ print $4 }' | sort -n | uniq 
	;;
	*)
	if [ cmd != reject ]; then echo "Sorry, $1 is not valid.";
	   elif
	[ cmd != discard ]; then echo "Sorry, $1 is not valid.";
	   elif
	[ cmd != badheader ]; then echo "Sorry, $1 is not valid.";
	   elif
	[ cmd != check ]; then echo "Sorry, $1 is not valid.";
	   elif
	[ cmd != save ]; then echo "Sorry, $1 is not valid.";
	   elif
	[ cmd != iptab ]; then echo "Sorry, $1 is not valid.";
	   elif
	[ cmd != uploadconfig ]; then echo "Sorry, $1 is not valid.";
	   elif
	[ cmd != save ]; then echo "Sorry, $1 is not valid.";
	   elif
	[ cmd != sort ]; then echo "Sorry, $1 is not valid.";
	   elif
	[ cmd != help ]; then echo "Sorry, $1 is not valid."; fi
	;;
esac
